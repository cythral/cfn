Description: Core CloudFormation services including webhooks and alarms
Transform: AWS::Serverless-2016-10-31
Parameters:
  GithubOwner:
    Type: String
    Description: Organization/user that owns repositories the CICD webhook will handle.

  GithubToken:
    Type: String
    NoEcho: true
    Description: Encrypted Github token

  GithubSigningSecret:
    Type: String
    NoEcho: true
    Description: Encrypted signing secret Github uses to sign requests with.

  TemplateFilename:
    Type: String
    Description: Filename of cicd templates to look for in repositories

  PipelineDefinitionFilename:
    Type: String
    Description: Filename of the pipeline definition file to look for in repositories

  StackSuffix:
    Type: String
    Description: Suffix to append to the repository name when creating cicd stacks

  DevVpcId:
    Type: String
    Default: ""
    Description: ID of the VPC to peer to in dev

  ProdVpcId:
    Type: String
    Default: ""
    Description: ID of the VPC to peer to in prod

  DevLoadBalancerDnsName:
    Type: String
    Default: ""
    Description: DNS name of the dev load balancer

  ProdLoadBalancerDnsName:
    Type: String
    Default: ""
    Description: DNS name of the prod load balancer

  Version:
    Type: String
    Default: "1"
    Description: Version of the stack being deployed

  RunEndToEndTests:
    Type: String
    Default: "no"
    Description: Whether or not to run end to end tests
    AllowedValues:
      - "yes"
      - "no"

Conditions:
  SetupDevAccount: !Not
    - !Equals
      - !Ref DevVpcId
      - ""

  SetupProdAccount: !Not
    - !Equals
      - !Ref ProdVpcId
      - ""

  RunEndToEndTests: !Equals
    - !Ref RunEndToEndTests
    - "yes"

Resources:
  DevPeeringConnection:
    Type: AWS::EC2::VPCPeeringConnection
    Condition: SetupDevAccount
    Properties:
      PeerOwnerId: !ImportValue cfn-metadata:DevAccountId
      PeerRoleArn: !ImportValue cfn-metadata:DevAgentRoleArn
      PeerVpcId: !Ref DevVpcId
      VpcId: !ImportValue cfn-utilities:VpcId

  DevPeeringRoute:
    Type: AWS::EC2::Route
    Condition: SetupDevAccount
    Properties:
      DestinationCidrBlock: 10.2.0.0/16
      RouteTableId: !ImportValue cfn-utilities:RouteTableId
      VpcPeeringConnectionId: !Ref DevPeeringConnection

  DevListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Condition: SetupDevAccount
    Properties:
      ListenerArn: !ImportValue cfn-gateway:HttpsListenerArn
      Priority: 2
      Actions:
        - Type: authenticate-oidc
          Order: 1
          AuthenticateOidcConfig:
            Issuer: https://accounts.google.com
            AuthorizationEndpoint: https://accounts.google.com/o/oauth2/v2/auth
            TokenEndpoint: https://oauth2.googleapis.com/token
            UserInfoEndpoint: https://openidconnect.googleapis.com/v1/userinfo
            ClientId: !ImportValue sso-aws-registry:DevGoogleClientId
            ClientSecret: !GetAtt DecryptedDevClientSecret.Plaintext
            SessionTimeout: 86400
        - Type: forward
          Order: 2
          TargetGroupArn: !ImportValue cfn-gateway:DevTargetGroupArn
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - "dev.*"
              - "*.dev.*"

  DecryptedDevClientSecret:
    Type: Custom::Secret
    Properties:
      ServiceToken: !ImportValue cfn-secret-resource:SecretLambdaArn
      Ciphertext: !ImportValue sso-aws-registry:DevGoogleClientSecret

  DevTargetGroupAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: SetupDevAccount
    Properties:
      AlarmDescription: Dev load balancer target health
      AlarmActions:
        - !Ref UpdateTargetsTopic
      Threshold: 0.0
      TreatMissingData: breaching
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      Metrics:
        - Id: healthyfactor
          Expression: healthy == 0 OR unhealthy > 0
          ReturnData: true
        - Id: unhealthy
          MetricStat:
            Metric:
              Namespace: AWS/ApplicationELB
              MetricName: UnHealthyHostCount
              Dimensions:
                - Name: LoadBalancer
                  Value: !ImportValue cfn-gateway:LoadBalancerFullName
                - Name: TargetGroup
                  Value: !ImportValue cfn-gateway:DevTargetGroupFullName
            Stat: Maximum
            Period: 60
          ReturnData: false
        - Id: healthy
          MetricStat:
            Metric:
              Namespace: AWS/ApplicationELB
              MetricName: HealthyHostCount
              Dimensions:
                - Name: LoadBalancer
                  Value: !ImportValue cfn-gateway:LoadBalancerFullName
                - Name: TargetGroup
                  Value: !ImportValue cfn-gateway:DevTargetGroupFullName
            Stat: Maximum
            Period: 60
          ReturnData: false
        - Id: customdata
          MetricStat:
            Metric:
              Namespace: CustomData
              MetricName: CustomData
              Dimensions:
                - Name: TargetGroupArn
                  Value: !ImportValue cfn-gateway:DevTargetGroupArn
                - Name: TargetDnsName
                  Value: !Ref DevLoadBalancerDnsName
            Stat: Maximum
            Period: 60
          ReturnData: false

  ProdPeeringConnection:
    Type: AWS::EC2::VPCPeeringConnection
    Condition: SetupProdAccount
    Properties:
      PeerOwnerId: !ImportValue cfn-metadata:ProdAccountId
      PeerRoleArn: !ImportValue cfn-metadata:ProdAgentRoleArn
      PeerVpcId: !Ref ProdVpcId
      VpcId: !ImportValue cfn-utilities:VpcId

  ProdPeeringRoute:
    Type: AWS::EC2::Route
    Condition: SetupProdAccount
    Properties:
      DestinationCidrBlock: 10.3.0.0/16
      RouteTableId: !ImportValue cfn-utilities:RouteTableId
      VpcPeeringConnectionId: !Ref ProdPeeringConnection

  ProdTargetGroupAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: SetupProdAccount
    Properties:
      AlarmDescription: Prod load balancer target health
      AlarmActions:
        - !Ref UpdateTargetsTopic
      Threshold: 0.0
      EvaluationPeriods: 1
      TreatMissingData: breaching
      ComparisonOperator: GreaterThanThreshold
      Metrics:
        - Id: healthyfactor
          Expression: healthy == 0 OR unhealthy > 0
          ReturnData: true
        - Id: unhealthy
          MetricStat:
            Metric:
              Namespace: AWS/ApplicationELB
              MetricName: UnHealthyHostCount
              Dimensions:
                - Name: LoadBalancer
                  Value: !ImportValue cfn-gateway:LoadBalancerFullName
                - Name: TargetGroup
                  Value: !ImportValue cfn-gateway:ProdTargetGroupFullName
            Stat: Maximum
            Period: 60
          ReturnData: false
        - Id: healthy
          MetricStat:
            Metric:
              Namespace: AWS/ApplicationELB
              MetricName: HealthyHostCount
              Dimensions:
                - Name: LoadBalancer
                  Value: !ImportValue cfn-gateway:LoadBalancerFullName
                - Name: TargetGroup
                  Value: !ImportValue cfn-gateway:ProdTargetGroupFullName
            Stat: Maximum
            Period: 60
          ReturnData: false
        - Id: customdata
          MetricStat:
            Metric:
              Namespace: CustomData
              MetricName: CustomData
              Dimensions:
                - Name: TargetGroupArn
                  Value: !ImportValue cfn-gateway:ProdTargetGroupArn
                - Name: TargetDnsName
                  Value: !Ref ProdLoadBalancerDnsName
            Stat: Maximum
            Period: 60
          ReturnData: false

  GithubWebhookArtifactStore:
    Type: AWS::S3::Bucket

  GithubWebhookArtifactStorePolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref GithubWebhookArtifactStore
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource: !Sub arn:aws:s3:::${GithubWebhookArtifactStore}/*
            Principal:
              AWS: !GetAtt GithubWebhookRole.Arn

  GithubWebhookStatusTopic:
    Type: AWS::SNS::Topic

  GithubWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Handler: GithubWebhook::Cythral.CloudFormation.GithubWebhook.Handler::Run
      Runtime: dotnetcore3.1
      Timeout: 30
      CodeUri: ../../bin/GithubWebhook/Release/netcoreapp3.1/publish/
      MemorySize: 512
      Policies:
        - AWSLambdaExecute
        - !Ref GithubWebhookPolicy
        - !ImportValue cfn-utilities:SecretsKeyDecryptPolicyArn
      AutoPublishAlias: GithubWebhook
      Environment:
        Variables:
          GithubWebhook__GithubOwner: !Ref GithubOwner
          GithubWebhook__GithubToken: !Ref GithubToken
          GithubWebhook__GithubSigningSecret: !Ref GithubSigningSecret
          GithubWebhook__StatusNotificationTopicArn: !Ref GithubWebhookStatusTopic
          GithubWebhook__TemplateFileName: !Ref TemplateFilename
          GithubWebhook__PipelineDefinitionFilename: !Ref PipelineDefinitionFilename
          GithubWebhook__StackSuffix: !Ref StackSuffix
          GithubWebhook__RoleArn: !ImportValue cfn-utilities:MasterRoleArn
          GithubWebhook__ArtifactStore: !Ref GithubWebhookArtifactStore
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
          LAMBDA_NET_SERIALIZER_DEBUG: "true"

  GithubWebhookPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - cloudformation:CreateStack
              - cloudformation:UpdateStack
              - cloudformation:DescribeStacks
              - states:StartExecution
            Resource: "*"
          - Effect: Allow
            Action: iam:PassRole
            Resource: !ImportValue cfn-utilities:MasterRoleArn

  GithubWebhookPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GithubWebhook.Alias
      Principal: elasticloadbalancing.amazonaws.com
      SourceArn: !Sub arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/cfn-core-GithubWebhookTarget/*

  GithubWebhookTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    DependsOn: GithubWebhookPermission
    Properties:
      Name: cfn-core-GithubWebhookTarget
      TargetType: lambda
      TargetGroupAttributes:
        - Key: lambda.multi_value_headers.enabled
          Value: false
      Targets:
        - Id: !Ref GithubWebhook.Alias

  GithubWebhookListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !ImportValue cfn-gateway:HttpsListenerArn
      Priority: 1
      Actions:
        - Type: forward
          TargetGroupArn: !Ref GithubWebhookTargetGroup
      Conditions:
        - Field: http-request-method
          HttpRequestMethodConfig:
            Values:
              - POST
        - Field: host-header
          HostHeaderConfig:
            Values:
              - brigh.id
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - /webhooks/github

  GithubWebhookEndToEndTests:
    Type: AWS::Serverless::Function
    Properties:
      Handler: GithubWebhookEndToEnd::Cythral.CloudFormation.Tests.EndToEnd.GithubWebhook.Runner::Handle
      Runtime: dotnetcore3.1
      Timeout: 900
      MemorySize: 512
      CodeUri: ../../bin/GithubWebhookEndToEnd/Release/netcoreapp3.1/publish/
      Policies:
        - AdministratorAccess
      Environment:
        Variables:
          GITHUB_TOKEN: !Ref GithubToken
          GITHUB_SIGNING_SECRET: !Ref GithubSigningSecret
          AWS_ACCOUNT_ID: !Ref AWS::AccountId

  GithubWebhoookEndToEndTestRunner:
    Type: Custom::TestRunner
    Condition: RunEndToEndTests
    DependsOn: GithubWebhookAliasGithubWebhook
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      ServiceToken: !GetAtt GithubWebhookEndToEndTests.Arn
      Serial: !Ref Version

  UpdateTargetsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: UpdateTargets::Cythral.CloudFormation.UpdateTargets.Handler::Run
      Runtime: dotnetcore3.1
      Timeout: 30
      CodeUri: ../../bin/UpdateTargets/Release/netcoreapp3.1/publish/
      Policies:
        - AWSLambdaExecute
        - !Ref UpdateTargetsPolicy
      Environment:
        Variables:
          LAMBDA_NET_SERIALIZER_DEBUG: "true"
      Events:
        SNS:
          Type: SNS
          Properties:
            Topic: !Ref UpdateTargetsTopic
            Region: !Ref AWS::Region

  UpdateTargetsTopic:
    Type: AWS::SNS::Topic

  UpdateTargetsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - elasticloadbalancing:DescribeTargetHealth
              - elasticloadbalancing:RegisterTargets
              - elasticloadbalancing:DeregisterTargets
            Resource: "*"

  StackDeploymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: StackDeployment::Cythral.CloudFormation.StackDeployment.Handler::Run
      Runtime: dotnetcore3.1
      Timeout: 300
      CodeUri: ../../bin/StackDeployment/Release/netcoreapp3.1/publish/
      Role: !ImportValue cfn-utilities:MasterRoleArn
      Environment:
        Variables:
          LAMBDA_NET_SERIALIZER_DEBUG: "true"
          Config__NotificationArn: !Ref StackDeploymentStatusTopic
          Config__GithubToken: !Ref GithubToken

  StackDeploymentFunctionRetryPolicy:
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      FunctionName: !Ref StackDeploymentFunction
      MaximumRetryAttempts: 0
      Qualifier: $LATEST

  StackDeploymentStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: StackDeploymentStatus::Cythral.CloudFormation.StackDeploymentStatus.Handler::Run
      Runtime: dotnetcore3.1
      Timeout: 30
      CodeUri: ../../bin/StackDeploymentStatus/Release/netcoreapp3.1/publish/
      Role: !ImportValue cfn-utilities:MasterRoleArn
      Events:
        GithubWebhookStatus:
          Type: SNS
          Properties:
            Topic: !Ref GithubWebhookStatusTopic
            Region: !Ref AWS::Region
        StackDeploymentStatus:
          Type: SNS
          Properties:
            Topic: !Ref StackDeploymentStatusTopic
            Region: !Ref AWS::Region
      Environment:
        Variables:
          LAMBDA_NET_SERIALIZER_DEBUG: "true"
          Config__GithubToken: !Ref GithubToken
          Config__GithubOwner: !Ref GithubOwner
          Config__GithubTopicArn: !Ref GithubWebhookStatusTopic
          Config__StackSuffix: !Ref StackSuffix

  StackDeploymentStatusTopic:
    Type: AWS::SNS::Topic

  StackDeploymentStatusTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sns:Publish
            Resource: "*"
            Principal:
              AWS:
                - !ImportValue cfn-metadata:DevAgentRoleArn
                - !ImportValue cfn-metadata:ProdAgentRoleArn
      Topics:
        - !Ref StackDeploymentStatusTopic

  StateStore:
    Type: AWS::S3::Bucket

  ApprovalWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Handler: ApprovalWebhook::Cythral.CloudFormation.ApprovalWebhook.Handler::Handle
      Runtime: dotnetcore3.1
      Timeout: 30
      CodeUri: ../../bin/ApprovalWebhook/Release/netcoreapp3.1/publish/
      MemorySize: 256
      Policies:
        - AWSLambdaExecute
        - !Ref ApprovalWebhookPolicy
      AutoPublishAlias: ApprovalWebhook
      Environment:
        Variables:
          STATE_STORE: !Ref StateStore
          LAMBDA_NET_SERIALIZER_DEBUG: "true"

  ApprovalWebhookPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - states:SendTaskSuccess
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:DeleteObject
              - s3:GetObject
              - kms:Decrypt
            Resource: !Sub arn:aws:s3:::${StateStore}/*

  ApprovalWebhookPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ApprovalWebhook.Alias
      Principal: elasticloadbalancing.amazonaws.com
      SourceArn: !Sub arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/cfn-core-ApprovalWebhookTarget/*

  ApprovalWebhookTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    DependsOn: ApprovalWebhookPermission
    Properties:
      Name: cfn-core-ApprovalWebhookTarget
      TargetType: lambda
      TargetGroupAttributes:
        - Key: lambda.multi_value_headers.enabled
          Value: false
      Targets:
        - Id: !Ref ApprovalWebhook.Alias

  ApprovalWebhookListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !ImportValue cfn-gateway:HttpsListenerArn
      Priority: 3
      Actions:
        - Type: authenticate-oidc
          Order: 1
          AuthenticateOidcConfig:
            Issuer: https://accounts.google.com
            AuthorizationEndpoint: https://accounts.google.com/o/oauth2/v2/auth
            TokenEndpoint: https://oauth2.googleapis.com/token
            UserInfoEndpoint: https://openidconnect.googleapis.com/v1/userinfo
            ClientId: !ImportValue sso-aws-registry:SharedGoogleClientId
            ClientSecret: !GetAtt DecryptedSharedClientSecret.Plaintext
            SessionTimeout: 86400
        - Type: forward
          Order: 2
          TargetGroupArn: !Ref ApprovalWebhookTargetGroup
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - brigh.id
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - /webhooks/approval

  DecryptedSharedClientSecret:
    Type: Custom::Secret
    Properties:
      ServiceToken: !ImportValue cfn-secret-resource:SecretLambdaArn
      Ciphertext: !ImportValue sso-aws-registry:SharedGoogleClientSecret

  ApprovalTopic:
    Type: AWS::SNS::Topic

  ApprovalNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: ApprovalNotification::Cythral.CloudFormation.ApprovalNotification.Handler::Handle
      Runtime: dotnetcore3.1
      Timeout: 30
      MemorySize: 256
      CodeUri: ../../bin/ApprovalNotification/Release/netcoreapp3.1/publish/
      Policies:
        - AWSLambdaExecute
        - !Ref ApprovalNotificationPolicy
      Environment:
        Variables:
          TOPIC_ARN: !Ref ApprovalTopic
          BASE_URL: https://brigh.id/webhooks/approval
          STATE_STORE: !Ref StateStore
          LAMBDA_NET_SERIALIZER_DEBUG: "true"

  ApprovalNotificationPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - sns:Publish
            Resource: !Ref ApprovalTopic
          - Effect: Allow
            Action:
              - states:SendTaskSuccess
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
            Resource:
              - !Sub arn:aws:s3:::${StateStore}
              - !Sub arn:aws:s3:::${StateStore}/*

  DeploymentSupersessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: DeploymentSupersession::Cythral.CloudFormation.DeploymentSupersession.Handler::Handle
      Runtime: dotnetcore3.1
      Timeout: 30
      MemorySize: 256
      CodeUri: ../../bin/DeploymentSupersession/Release/netcoreapp3.1/publish/
      Policies:
        - AWSLambdaExecute
        - !Ref DeploymentSupersessionPolicy
      Environment:
        Variables:
          STATE_STORE: !Ref StateStore
          LAMBDA_NET_SERIALIZER_DEBUG: "true"

  DeploymentSupersessionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - states:SendTaskSuccess
              - sqs:GetQueueAttributes
              - sqs:ReceiveMessage
              - sqs:DeleteMessage
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource:
              - !Sub arn:aws:s3:::${StateStore}/*

  ExtractFileFromZipFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: ExtractFileFromZip::Cythral.CloudFormation.ExtractFileFromZip.Handler::Handle
      Runtime: dotnetcore3.1
      Timeout: 30
      MemorySize: 256
      CodeUri: ../../bin/ExtractFileFromZip/Release/netcoreapp3.1/publish/
      Policies:
        - AWSLambdaExecute
        - !Ref ExtractFileFromZipPolicy
      Environment:
        Variables:
          LAMBDA_NET_SERIALIZER_DEBUG: "true"

  ExtractFileFromZipPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - kms:Decrypt
            Resource: "*"

  S3DeploymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: S3Deployment::Cythral.CloudFormation.S3Deployment.Handler::Handle
      Runtime: dotnetcore3.1
      Timeout: 300
      MemorySize: 256
      CodeUri: ../../bin/S3Deployment/Release/netcoreapp3.1/publish/
      Role: !ImportValue cfn-utilities:MasterRoleArn
      Environment:
        Variables:
          LAMBDA_NET_SERIALIZER_DEBUG: "true"
          GITHUB_TOKEN: !Ref GithubToken

  S3TagOutdatedArtifactsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: S3TagOutdatedArtifacts::Cythral.CloudFormation.S3TagOutdatedArtifacts.Handler::Run
      Runtime: dotnetcore3.1
      Timeout: 300
      MemorySize: 256
      CodeUri: ../../bin/S3TagOutdatedArtifacts/Release/netcoreapp3.1/publish/
      Role: !ImportValue cfn-utilities:MasterRoleArn

  GithubTokenSecret:
    Type: Custom::Secret
    Properties:
      ServiceToken: !ImportValue cfn-secret-resource:SecretLambdaArn
      Ciphertext: !Ref GithubToken

  CodeBuildSourceCredential:
    Type: AWS::CodeBuild::SourceCredential
    Properties:
      Token: !GetAtt GithubTokenSecret.Plaintext
      ServerType: GITHUB
      AuthType: PERSONAL_ACCESS_TOKEN

Outputs:
  DevPeeringConnectionId:
    Value: !Ref DevPeeringConnection
    Condition: SetupDevAccount
    Description: Id of the peering connection with the dev account
    Export:
      Name: !Sub ${AWS::StackName}:DevPeeringConnectionId

  ProdPeeringConnectionId:
    Value: !Ref ProdPeeringConnection
    Condition: SetupProdAccount
    Description: Id of the peering connection with the prod account
    Export:
      Name: !Sub ${AWS::StackName}:ProdPeeringConnectionId

  StackDeploymentFunctionArn:
    Value: !GetAtt StackDeploymentFunction.Arn
    Description: ARN of the stack deployment function for use in step function pipelines
    Export:
      Name: !Sub ${AWS::StackName}:StackDeploymentFunctionArn

  ApprovalNotificationFunctionArn:
    Value: !GetAtt ApprovalNotificationFunction.Arn
    Description: ARN of the approval notification function for use in step function pipelines
    Export:
      Name: !Sub ${AWS::StackName}:ApprovalNotificationFunctionArn

  DeploymentSupersessionFunctionArn:
    Value: !GetAtt DeploymentSupersessionFunction.Arn
    Description: ARN of the deployment supersession function for use in step function pipelines
    Export:
      Name: !Sub ${AWS::StackName}:DeploymentSupersessionFunctionArn

  ExtractFileFromZipFunctionArn:
    Value: !GetAtt ExtractFileFromZipFunction.Arn
    Description: ARN of the file extraction function for use in step function pipelines
    Export:
      Name: !Sub ${AWS::StackName}:ExtractFileFromZipFunctionArn

  S3DeploymentFunctionArn:
    Value: !GetAtt S3DeploymentFunction.Arn
    Description: ARN of the S3 Deployment function for use in step function pipelines
    Export:
      Name: !Sub ${AWS::StackName}:S3DeploymentFunctionArn

  S3TagOutdatedArtifactsFunctionArn:
    Value: !GetAtt S3TagOutdatedArtifactsFunction.Arn
    Description: ARN of the S3 Tag Outdated Artifacts function for use in step function pipelines
    Export:
      Name: !Sub ${AWS::StackName}:S3TagOutdatedArtifactsFunctionArn
